============================= test session starts ==============================
platform darwin -- Python 3.13.2, pytest-7.4.0, pluggy-1.5.0 -- /Users/jacobrees/waveger2/backend/venv/bin/python3.13
cachedir: .pytest_cache
rootdir: /Users/jacobrees/waveger2/backend
configfile: pytest.ini
collecting ... collected 51 items

tests/test_app.py::test_app_creation PASSED                              [  1%]
tests/test_app.py::test_cache_initialization PASSED                      [  3%]
tests/test_app.py::test_blueprint_registration PASSED                    [  5%]
tests/test_app.py::test_cache_config[CACHE_TYPE-RedisCache] PASSED       [  7%]
tests/test_app.py::test_cache_config[CACHE_DEFAULT_TIMEOUT-3600] PASSED  [  9%]
tests/test_apple_music.py::test_token_generation_and_caching[False] SKIPPED [ 11%]
tests/test_apple_music.py::test_token_generation_and_caching[True] SKIPPED [ 13%]
tests/test_apple_music.py::test_token_jwt_format SKIPPED (Apple Music
credentials not available)                                               [ 15%]
tests/test_apple_music.py::test_missing_credentials FAILED               [ 17%]
tests/test_apple_music.py::test_search_song[Bohemian Rhapsody-Queen-True] SKIPPED [ 19%]
tests/test_apple_music.py::test_search_song[This Song Definitely Does Not Exist-Nonexistent Artist-False] SKIPPED [ 21%]
tests/test_apple_music.py::test_search_caching SKIPPED (Apple Music
credentials not available)                                               [ 23%]
tests/test_apple_music.py::test_enrich_chart_data[chart_format] SKIPPED  [ 25%]
tests/test_apple_music.py::test_enrich_chart_data[songs_format] SKIPPED  [ 27%]
tests/test_apple_music.py::test_already_enriched_data SKIPPED (Apple
Music credentials not available)                                         [ 29%]
tests/test_apple_music.py::test_api_error_handling SKIPPED (Apple Music
credentials not available)                                               [ 31%]
tests/test_billboard_api.py::test_get_default_chart FAILED               [ 33%]
tests/test_billboard_api.py::test_get_chart_by_id[billboard-200] FAILED  [ 35%]
tests/test_billboard_api.py::test_get_chart_by_id[artist-100] FAILED     [ 37%]
tests/test_billboard_api.py::test_historical_chart_caching PASSED        [ 39%]
tests/test_billboard_api.py::test_refresh_parameter PASSED               [ 41%]
tests/test_billboard_api.py::test_tuesday_refresh PASSED                 [ 43%]
tests/test_billboard_api.py::test_apple_music_parameter[true] FAILED     [ 45%]
tests/test_billboard_api.py::test_apple_music_parameter[false] FAILED    [ 47%]
tests/test_billboard_api.py::test_error_handling[rate_limit-429] FAILED  [ 49%]
tests/test_billboard_api.py::test_error_handling[server_error-500] ERROR [ 50%]
tests/test_billboard_api.py::test_exception_handling[timeout] FAILED     [ 52%]
tests/test_billboard_api.py::test_exception_handling[connection] FAILED  [ 54%]
tests/test_caching.py::test_cache_set_get[string value] PASSED           [ 56%]
tests/test_caching.py::test_cache_set_get[42] PASSED                     [ 58%]
tests/test_caching.py::test_cache_set_get[test_data2] PASSED             [ 60%]
tests/test_caching.py::test_cache_set_get[test_data3] PASSED             [ 62%]
tests/test_caching.py::test_cache_set_get[None] PASSED                   [ 64%]
tests/test_caching.py::test_cache_timeout[1-True] PASSED                 [ 66%]
tests/test_caching.py::test_cache_timeout[None-False] ERROR              [ 68%]
tests/test_caching.py::test_cache_delete PASSED                          [ 70%]
tests/test_caching.py::test_cache_clear PASSED                           [ 72%]
tests/test_caching.py::test_application_cache_patterns[billboard:hot-100-data0] PASSED [ 74%]
tests/test_caching.py::test_application_cache_patterns[billboard:hot-100:2022-01-01-data1] PASSED [ 76%]
tests/test_caching.py::test_application_cache_patterns[apple_music:token-dummy_token] PASSED [ 78%]
tests/test_caching.py::test_application_cache_patterns[apple_music:search:Song:Artist-data3] PASSED [ 80%]
tests/test_caching.py::test_application_cache_patterns[billboard:rate_limited-True] ERROR [ 82%]
tests/test_caching.py::test_redis_connectivity PASSED                    [ 84%]
tests/test_caching.py::test_null_values FAILED                           [ 86%]
tests/test_integration.py::test_chart_retrieval_with_caching FAILED      [ 88%]
tests/test_integration.py::test_historical_chart[2000-01-01] FAILED      [ 90%]
tests/test_integration.py::test_refresh_cached_chart PASSED              [ 92%]
tests/test_integration.py::test_apple_music_integration[true] ERROR      [ 94%]
tests/test_integration.py::test_apple_music_integration[false] ERROR     [ 96%]
tests/test_integration.py::test_concurrent_chart_requests PASSED         [ 98%]
tests/test_integration.py::test_concurrent_chart_requests ERROR          [ 98%]
tests/test_integration.py::test_performance_of_cached_responses FAILED   [100%]

==================================== ERRORS ====================================
___________ ERROR at setup of test_error_handling[server_error-500] ____________

    @pytest.fixture
    def client():
        """Create Flask test client"""
        app = create_app()
        app.config['TESTING'] = True
        with app.test_client() as client:
            with app.app_context():
>               cache.clear()

tests/test_billboard_api.py:17: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
venv/lib/python3.13/site-packages/flask_caching/__init__.py:214: in clear
    return self.cache.clear()
venv/lib/python3.13/site-packages/cachelib/redis.py:137: in clear
    keys = self._read_client.keys(self.key_prefix + "*")
venv/lib/python3.13/site-packages/redis/commands/core.py:1959: in keys
    return self.execute_command("KEYS", pattern, **kwargs)
venv/lib/python3.13/site-packages/redis/client.py:1266: in execute_command
    conn = self.connection or pool.get_connection(command_name, **options)
venv/lib/python3.13/site-packages/redis/connection.py:1461: in get_connection
    connection.connect()
venv/lib/python3.13/site-packages/redis/connection.py:719: in connect
    self.on_connect()
venv/lib/python3.13/site-packages/redis/connection.py:763: in on_connect
    auth_response = self.read_response()
venv/lib/python3.13/site-packages/redis/connection.py:882: in read_response
    response = self._parser.read_response(disable_decoding=disable_decoding)
venv/lib/python3.13/site-packages/redis/connection.py:349: in read_response
    result = self._read_response(disable_decoding=disable_decoding)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <redis.connection.PythonParser object at 0x1037b7000>
disable_decoding = False

    def _read_response(self, disable_decoding=False):
        raw = self._buffer.readline()
        if not raw:
            raise ConnectionError(SERVER_CLOSED_CONNECTION_ERROR)
    
        byte, response = raw[:1], raw[1:]
    
        # server returned an error
        if byte == b"-":
            response = response.decode("utf-8", errors="replace")
            error = self.parse_error(response)
            # if the error is a ConnectionError, raise immediately so the user
            # is notified
            if isinstance(error, ConnectionError):
>               raise error
E               redis.exceptions.ConnectionError: max number of clients reached

venv/lib/python3.13/site-packages/redis/connection.py:372: ConnectionError
_______________ ERROR at setup of test_cache_timeout[None-False] _______________

    @pytest.fixture
    def app_context():
        """Create Flask app context for testing"""
        app = create_app()
        app.config['TESTING'] = True
        with app.app_context():
>           cache.clear()

tests/test_caching.py:12: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
venv/lib/python3.13/site-packages/flask_caching/__init__.py:214: in clear
    return self.cache.clear()
venv/lib/python3.13/site-packages/cachelib/redis.py:137: in clear
    keys = self._read_client.keys(self.key_prefix + "*")
venv/lib/python3.13/site-packages/redis/commands/core.py:1959: in keys
    return self.execute_command("KEYS", pattern, **kwargs)
venv/lib/python3.13/site-packages/redis/client.py:1266: in execute_command
    conn = self.connection or pool.get_connection(command_name, **options)
venv/lib/python3.13/site-packages/redis/connection.py:1461: in get_connection
    connection.connect()
venv/lib/python3.13/site-packages/redis/connection.py:719: in connect
    self.on_connect()
venv/lib/python3.13/site-packages/redis/connection.py:763: in on_connect
    auth_response = self.read_response()
venv/lib/python3.13/site-packages/redis/connection.py:882: in read_response
    response = self._parser.read_response(disable_decoding=disable_decoding)
venv/lib/python3.13/site-packages/redis/connection.py:349: in read_response
    result = self._read_response(disable_decoding=disable_decoding)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <redis.connection.PythonParser object at 0x104eed010>
disable_decoding = False

    def _read_response(self, disable_decoding=False):
        raw = self._buffer.readline()
        if not raw:
            raise ConnectionError(SERVER_CLOSED_CONNECTION_ERROR)
    
        byte, response = raw[:1], raw[1:]
    
        # server returned an error
        if byte == b"-":
            response = response.decode("utf-8", errors="replace")
            error = self.parse_error(response)
            # if the error is a ConnectionError, raise immediately so the user
            # is notified
            if isinstance(error, ConnectionError):
>               raise error
E               redis.exceptions.ConnectionError: max number of clients reached

venv/lib/python3.13/site-packages/redis/connection.py:372: ConnectionError
_ ERROR at setup of test_application_cache_patterns[billboard:rate_limited-True] _

    @pytest.fixture
    def app_context():
        """Create Flask app context for testing"""
        app = create_app()
        app.config['TESTING'] = True
        with app.app_context():
>           cache.clear()

tests/test_caching.py:12: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
venv/lib/python3.13/site-packages/flask_caching/__init__.py:214: in clear
    return self.cache.clear()
venv/lib/python3.13/site-packages/cachelib/redis.py:137: in clear
    keys = self._read_client.keys(self.key_prefix + "*")
venv/lib/python3.13/site-packages/redis/commands/core.py:1959: in keys
    return self.execute_command("KEYS", pattern, **kwargs)
venv/lib/python3.13/site-packages/redis/client.py:1266: in execute_command
    conn = self.connection or pool.get_connection(command_name, **options)
venv/lib/python3.13/site-packages/redis/connection.py:1461: in get_connection
    connection.connect()
venv/lib/python3.13/site-packages/redis/connection.py:719: in connect
    self.on_connect()
venv/lib/python3.13/site-packages/redis/connection.py:763: in on_connect
    auth_response = self.read_response()
venv/lib/python3.13/site-packages/redis/connection.py:882: in read_response
    response = self._parser.read_response(disable_decoding=disable_decoding)
venv/lib/python3.13/site-packages/redis/connection.py:349: in read_response
    result = self._read_response(disable_decoding=disable_decoding)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <redis.connection.PythonParser object at 0x107ba77e0>
disable_decoding = False

    def _read_response(self, disable_decoding=False):
        raw = self._buffer.readline()
        if not raw:
            raise ConnectionError(SERVER_CLOSED_CONNECTION_ERROR)
    
        byte, response = raw[:1], raw[1:]
    
        # server returned an error
        if byte == b"-":
            response = response.decode("utf-8", errors="replace")
            error = self.parse_error(response)
            # if the error is a ConnectionError, raise immediately so the user
            # is notified
            if isinstance(error, ConnectionError):
>               raise error
E               redis.exceptions.ConnectionError: max number of clients reached

venv/lib/python3.13/site-packages/redis/connection.py:372: ConnectionError
_____________ ERROR at setup of test_apple_music_integration[true] _____________

    @pytest.fixture
    def client():
        """Create Flask test client"""
        app = create_app()
        app.config['TESTING'] = True
        with app.test_client() as client:
            with app.app_context():
>               cache.clear()

tests/test_integration.py:23: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
venv/lib/python3.13/site-packages/flask_caching/__init__.py:214: in clear
    return self.cache.clear()
venv/lib/python3.13/site-packages/cachelib/redis.py:137: in clear
    keys = self._read_client.keys(self.key_prefix + "*")
venv/lib/python3.13/site-packages/redis/commands/core.py:1959: in keys
    return self.execute_command("KEYS", pattern, **kwargs)
venv/lib/python3.13/site-packages/redis/client.py:1266: in execute_command
    conn = self.connection or pool.get_connection(command_name, **options)
venv/lib/python3.13/site-packages/redis/connection.py:1461: in get_connection
    connection.connect()
venv/lib/python3.13/site-packages/redis/connection.py:719: in connect
    self.on_connect()
venv/lib/python3.13/site-packages/redis/connection.py:763: in on_connect
    auth_response = self.read_response()
venv/lib/python3.13/site-packages/redis/connection.py:882: in read_response
    response = self._parser.read_response(disable_decoding=disable_decoding)
venv/lib/python3.13/site-packages/redis/connection.py:349: in read_response
    result = self._read_response(disable_decoding=disable_decoding)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <redis.connection.PythonParser object at 0x107ba5400>
disable_decoding = False

    def _read_response(self, disable_decoding=False):
        raw = self._buffer.readline()
        if not raw:
            raise ConnectionError(SERVER_CLOSED_CONNECTION_ERROR)
    
        byte, response = raw[:1], raw[1:]
    
        # server returned an error
        if byte == b"-":
            response = response.decode("utf-8", errors="replace")
            error = self.parse_error(response)
            # if the error is a ConnectionError, raise immediately so the user
            # is notified
            if isinstance(error, ConnectionError):
>               raise error
E               redis.exceptions.ConnectionError: max number of clients reached

venv/lib/python3.13/site-packages/redis/connection.py:372: ConnectionError
____________ ERROR at setup of test_apple_music_integration[false] _____________

    @pytest.fixture
    def client():
        """Create Flask test client"""
        app = create_app()
        app.config['TESTING'] = True
        with app.test_client() as client:
            with app.app_context():
>               cache.clear()

tests/test_integration.py:23: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
venv/lib/python3.13/site-packages/flask_caching/__init__.py:214: in clear
    return self.cache.clear()
venv/lib/python3.13/site-packages/cachelib/redis.py:137: in clear
    keys = self._read_client.keys(self.key_prefix + "*")
venv/lib/python3.13/site-packages/redis/commands/core.py:1959: in keys
    return self.execute_command("KEYS", pattern, **kwargs)
venv/lib/python3.13/site-packages/redis/client.py:1266: in execute_command
    conn = self.connection or pool.get_connection(command_name, **options)
venv/lib/python3.13/site-packages/redis/connection.py:1461: in get_connection
    connection.connect()
venv/lib/python3.13/site-packages/redis/connection.py:719: in connect
    self.on_connect()
venv/lib/python3.13/site-packages/redis/connection.py:763: in on_connect
    auth_response = self.read_response()
venv/lib/python3.13/site-packages/redis/connection.py:882: in read_response
    response = self._parser.read_response(disable_decoding=disable_decoding)
venv/lib/python3.13/site-packages/redis/connection.py:349: in read_response
    result = self._read_response(disable_decoding=disable_decoding)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <redis.connection.PythonParser object at 0x104eede80>
disable_decoding = False

    def _read_response(self, disable_decoding=False):
        raw = self._buffer.readline()
        if not raw:
            raise ConnectionError(SERVER_CLOSED_CONNECTION_ERROR)
    
        byte, response = raw[:1], raw[1:]
    
        # server returned an error
        if byte == b"-":
            response = response.decode("utf-8", errors="replace")
            error = self.parse_error(response)
            # if the error is a ConnectionError, raise immediately so the user
            # is notified
            if isinstance(error, ConnectionError):
>               raise error
E               redis.exceptions.ConnectionError: max number of clients reached

venv/lib/python3.13/site-packages/redis/connection.py:372: ConnectionError
_____________ ERROR at teardown of test_concurrent_chart_requests ______________

self = <RequestContext 'http://localhost/billboard_api.php?id=hot-100' [GET] of app>
exc = LookupError(<ContextVar name='flask.app_ctx' at 0x1024983b0>)

    def pop(self, exc: BaseException | None = _sentinel) -> None:  # type: ignore
        """Pops the request context and unbinds it by doing that.  This will
        also trigger the execution of functions registered by the
        :meth:`~flask.Flask.teardown_request` decorator.
    
        .. versionchanged:: 0.9
           Added the `exc` argument.
        """
        clear_request = len(self._cv_tokens) == 1
    
        try:
            if clear_request:
                if exc is _sentinel:
                    exc = sys.exc_info()[1]
>               self.app.do_teardown_request(exc)

venv/lib/python3.13/site-packages/flask/ctx.py:401: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
venv/lib/python3.13/site-packages/flask/app.py:2035: in do_teardown_request
    for name in chain(request.blueprints, (None,)):
venv/lib/python3.13/site-packages/werkzeug/local.py:318: in __get__
    obj = instance._get_current_object()
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

    def _get_current_object() -> T:
        try:
            obj = local.get()
        except LookupError:
>           raise RuntimeError(unbound_message) from None
E           RuntimeError: Working outside of request context.
E           
E           This typically means that you attempted to use functionality that needed
E           an active HTTP request. Consult the documentation on testing for
E           information about how to avoid this problem.

venv/lib/python3.13/site-packages/werkzeug/local.py:519: RuntimeError

During handling of the above exception, another exception occurred:

    @pytest.fixture
    def client():
        """Create Flask test client"""
        app = create_app()
        app.config['TESTING'] = True
>       with app.test_client() as client:

tests/test_integration.py:21: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
venv/lib/python3.13/site-packages/flask/testing.py:259: in __exit__
    self._context_stack.close()
/opt/homebrew/Cellar/python@3.13/3.13.2/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py:627: in close
    self.__exit__(None, None, None)
/opt/homebrew/Cellar/python@3.13/3.13.2/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py:619: in __exit__
    raise exc
/opt/homebrew/Cellar/python@3.13/3.13.2/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py:604: in __exit__
    if cb(*exc_details):
venv/lib/python3.13/site-packages/flask/ctx.py:434: in __exit__
    self.pop(exc_value)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <RequestContext 'http://localhost/billboard_api.php?id=hot-100' [GET] of app>
exc = LookupError(<ContextVar name='flask.app_ctx' at 0x1024983b0>)

    def pop(self, exc: BaseException | None = _sentinel) -> None:  # type: ignore
        """Pops the request context and unbinds it by doing that.  This will
        also trigger the execution of functions registered by the
        :meth:`~flask.Flask.teardown_request` decorator.
    
        .. versionchanged:: 0.9
           Added the `exc` argument.
        """
        clear_request = len(self._cv_tokens) == 1
    
        try:
            if clear_request:
                if exc is _sentinel:
                    exc = sys.exc_info()[1]
                self.app.do_teardown_request(exc)
    
                request_close = getattr(self.request, "close", None)
                if request_close is not None:
                    request_close()
        finally:
>           ctx = _cv_request.get()
E           LookupError: <ContextVar name='flask.request_ctx' at 0x102498450>

venv/lib/python3.13/site-packages/flask/ctx.py:407: LookupError
=================================== FAILURES ===================================
___________________________ test_missing_credentials ___________________________

app_context = None
monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x1031c6650>

    def test_missing_credentials(app_context, monkeypatch):
        """Test behavior when credentials are missing"""
        # Arrange - Save and remove credentials temporarily
        original_key_id = os.environ.get("APPLE_MUSIC_KEY_ID")
        original_team_id = os.environ.get("APPLE_MUSIC_TEAM_ID")
    
        try:
            monkeypatch.delenv("APPLE_MUSIC_KEY_ID", raising=False)
            monkeypatch.delenv("APPLE_MUSIC_TEAM_ID", raising=False)
    
            # Act
            token = AppleMusicService.get_token()
    
            # Assert
>           assert token is None
E           AssertionError: assert 'eyJhbGciOiJFUzI1NiIsImtpZCI6IjJKVktNMjdGUzYiLCJ0eXAiOiJKV1QifQ.eyJpc3MiOiI1UlA0V1JROVYyIiwiaWF0IjoxNzQ0ODA5MTY3LCJleHAiOjE3NDQ4NTIzNjd9.jCL_aAYJmJy9ELC7un8sZ9SsxoUeQvE8QesODwiUqv1pUs9fqk1LwyY-GzvS1hqo63g_Oiteb_pHXYAERsKa2Q' is None

tests/test_apple_music.py:70: AssertionError
____________________________ test_get_default_chart ____________________________

client = <FlaskClient <Flask 'app'>>

    def test_get_default_chart(client):
        """Test getting the default Hot 100 chart"""
        # Act
        response = client.get('/billboard_api.php')
        data = json.loads(response.data)
    
        # Assert
        assert response.status_code == 200
>       assert data['chart']['name'] == 'Hot 100'
E       KeyError: 'chart'

tests/test_billboard_api.py:30: KeyError
_____________________ test_get_chart_by_id[billboard-200] ______________________

client = <FlaskClient <Flask 'app'>>, chart_id = 'billboard-200'

    @pytest.mark.parametrize("chart_id", ["billboard-200", "artist-100"])
    def test_get_chart_by_id(client, chart_id):
        """Test getting different charts by ID"""
        # Act
        response = client.get(f'/billboard_api.php?id={chart_id}')
    
        # Assert
        if response.status_code == 200:
            data = json.loads(response.data)
>           assert 'chart' in data
E           AssertionError: assert 'chart' in {'cached': False, 'info': 'The week’s most popular albums as compiled by Luminate, based on multi-metric consumption (blending traditional album sales, track equivalent albums, and streaming equivalent albums).', 'songs': [{'apple_music': {'artwork_url': 'https://is1-ssl.mzstatic.com/image/thumb/Music211/v4/03/24/10/03241047-f22d-7e64-3932-6df7550acc42/25UMGIM46212.rgb.jpg/1000x1000bb.jpg', 'id': '1802175272', 'preview_url': 'https://audio-ssl.itunes.apple.com/itunes-assets/AudioPreview221/v4/6a/8e/b0/6a8eb05f-3ad8-b09b-2ece-8e38016aca5f/mzaf_4835852531038949804.plus.aac.p.m4a', 'url': 'https://music.apple.com/us/album/pop-out/1802175271?i=1802175272'}, 'artist': 'Playboi Carti', 'image': 'https://charts-static.billboard.com/img/2025/03/playboi-carti-ca2-music-0rc-180x180.jpg', 'last_week_position': 2, ...}, {'apple_music': {'artwork_url': 'https://is1-ssl.mzstatic.com/image/thumb/Music221/v4/14/2a/2d/142a2d3e-fb3a-e818-8c7b-6eeb92990084/25UMGIM42095.rgb.jpg/1000x1000bb.jpg', 'id': '1800580280', 'preview_url': 'https://audio-ssl.itunes.apple.com/itunes-assets/AudioPreview221/v4/3e/dc/74/3edc74a0-7b23-2cff-836c-07f8d828f001/mzaf_7758510392020481285.plus.aac.p.m4a', 'url': 'https://music.apple.com/us/album/twilight-zone/1800579610?i=1800580280'}, 'artist': 'Ariana Grande', 'image': 'https://charts-static.billboard.com/img/2024/03/ariana-grande-i9s-eternalsunshine-a1f-180x180.jpg', 'last_week_position': 1, ...}, {'apple_music': {'artwork_url': 'https://is1-ssl.mzstatic.com/image/thumb/Music211/v4/34/10/1e/34101e1f-f4b9-907a-ce47-3fba5b3ee5e8/50222.jpg/1000x1000bb.jpg', 'id': '1796127251', 'preview_url': 'https://audio-ssl.itunes.apple.com/itunes-assets/AudioPreview221/v4/91/89/1f/91891f9b-80af-a617-e287-1b921d4e5581/mzaf_7844717252150971547.plus.aac.p.m4a', 'url': 'https://music.apple.com/us/album/something-about-you/1796127242?i=1796127251'}, 'artist': 'PARTYNEXTDOOR & Drake', 'image': 'https://charts-static.billboard.com/img/2025/03/partynextdoor-83j-omeexyongs4u-6l7-180x180.jpg', 'last_week_position': 5, ...}, {'apple_music': {'artwork_url': 'https://is1-ssl.mzstatic.com/image/thumb/Music122/v4/bd/3b/a9/bd3ba9fb-9609-144f-bcfe-ead67b5f6ab3/196589564931.jpg/1000x1000bb.jpg', 'id': '1657869385', 'preview_url': 'https://audio-ssl.itunes.apple.com/itunes-assets/AudioPreview211/v4/86/1a/11/861a1188-c03d-9c14-0c4a-60dc9cc506f5/mzaf_16738874087482853288.plus.aac.p.m4a', 'url': 'https://music.apple.com/us/album/sos/1657869377?i=1657869385'}, 'artist': 'SZA', 'image': 'https://charts-static.billboard.com/img/2022/12/sza-xyh-sos-0s7-180x180.jpg', 'last_week_position': 6, ...}, {'apple_music': {'artwork_url': 'https://is1-ssl.mzstatic.com/image/thumb/Music211/v4/50/c2/cc/50c2cc95-3658-9417-0d4b-831abde44ba1/24UM1IM28978.rgb.jpg/1000x1000bb.jpg', 'id': '1781270554', 'preview_url': 'https://audio-ssl.itunes.apple.com/itunes-assets/AudioPreview211/v4/d1/b8/d4/d1b8d4c6-daf7-f6a0-e4fc-fb9abe0a4277/mzaf_834058705086793867.plus.aac.p.m4a', 'url': 'https://music.apple.com/us/album/gnx-feat-hitta-j3-youngthreat-peysoh/1781270319?i=1781270554'}, 'artist': 'Kendrick Lamar', 'image': 'https://charts-static.billboard.com/img/2024/12/kendrick-lamar-1hw-gnx-2n7-180x180.jpg', 'last_week_position': 4, ...}, {'apple_music': {'artwork_url': 'https://is1-ssl.mzstatic.com/image/thumb/Music221/v4/f6/15/d0/f615d0ab-e0c4-575d-907e-1cc084642357/24UMGIM61704.rgb.jpg/1000x1000bb.jpg', 'id': '1750307362', 'preview_url': 'https://audio-ssl.itunes.apple.com/itunes-assets/AudioPreview221/v4/60/70/99/607099f1-b04c-2901-0ce0-cf0dae7b4563/mzaf_13331510138185333320.plus.aac.p.m4a', 'url': 'https://music.apple.com/us/album/espresso/1750307020?i=1750307362'}, 'artist': 'Sabrina Carpenter', 'image': 'https://charts-static.billboard.com/img/2024/09/sabrina-carpenter-3b3-shortnsweet-v6a-180x180.jpg', 'last_week_position': 7, ...}, ...], 'title': 'Billboard 200™', ...}

tests/test_billboard_api.py:43: AssertionError
_______________________ test_get_chart_by_id[artist-100] _______________________

client = <FlaskClient <Flask 'app'>>, chart_id = 'artist-100'

    @pytest.mark.parametrize("chart_id", ["billboard-200", "artist-100"])
    def test_get_chart_by_id(client, chart_id):
        """Test getting different charts by ID"""
        # Act
        response = client.get(f'/billboard_api.php?id={chart_id}')
    
        # Assert
        if response.status_code == 200:
            data = json.loads(response.data)
>           assert 'chart' in data
E           AssertionError: assert 'chart' in {'cached': False, 'info': 'THE WEEK’S MOST POPULAR ARTISTS ACROSS ALL GENRES, RANKED BY ALBUM AND TRACK SALES AS PROVIDED BY LUMINATE, RADIO AIRPLAY AUDIENCE IMPRESSIONS AS PROVIDED BY LUMINATE, STREAMING ACTIVITY DATA FROM ONLINE MUSIC SOURCES TRACKED BY LUMINATE.', 'songs': [{'apple_music': {'artwork_url': 'https://is1-ssl.mzstatic.com/image/thumb/Music221/v4/13/14/53/13145323-bb09-4ea2-528a-24010d74af27/24UMGIM51280.rgb.jpg/1000x1000bb.jpg', 'id': '1750968657', 'preview_url': 'https://audio-ssl.itunes.apple.com/itunes-assets/AudioPreview221/v4/c6/5e/28/c65e289b-ebd6-c88e-a82a-0c5d5fe6cf1c/mzaf_17657095059562388216.plus.aac.p.m4a', 'url': 'https://music.apple.com/us/album/whiskey-whiskey-feat-morgan-wallen/1750968444?i=1750968657'}, 'image': 'https://charts-static.billboard.com/img/2018/01/morgan-wallen-dqx-artistchart-932-180x180.jpg', 'last_week_position': 2, 'name': 'Morgan Wallen', ...}, {'apple_music': {'artwork_url': 'https://is1-ssl.mzstatic.com/image/thumb/Music112/v4/0d/ae/61/0dae6140-d4af-d0df-eae0-3c92eb392a33/15UMGIM11922.rgb.jpg/1000x1000bb.jpg', 'id': '1440829463', 'preview_url': 'https://audio-ssl.itunes.apple.com/itunes-assets/AudioPreview221/v4/f7/62/53/f7625322-4d54-828f-5419-4fa182dddad7/mzaf_14915613629736305992.plus.aac.p.m4a', 'url': 'https://music.apple.com/us/album/alright/1440828886?i=1440829463'}, 'image': 'https://charts-static.billboard.com/img/2012/11/kendrick-lamar-1hw-artistchart-xmj-180x180.jpg', 'last_week_position': 3, 'name': 'Kendrick Lamar', ...}, {'apple_music': {'artwork_url': 'https://is1-ssl.mzstatic.com/image/thumb/Music112/v4/07/ef/6a/07ef6a69-ee75-ae04-f6a2-971be4b53828/22UMGIM63572.rgb.jpg/1000x1000bb.jpg', 'id': '1631578530', 'preview_url': 'https://audio-ssl.itunes.apple.com/itunes-assets/AudioPreview221/v4/fe/46/3d/fe463d64-1bd2-d87f-3bc8-e8c60b2445a7/mzaf_17626286940386380125.plus.aac.p.m4a', 'url': 'https://music.apple.com/us/album/because-i-liked-a-boy/1631578046?i=1631578530'}, 'image': 'https://charts-static.billboard.com/img/2014/08/sabrina-carpenter-3b3-artistchart-6e0-180x180.jpg', 'last_week_position': 4, 'name': 'Sabrina Carpenter', ...}, {'apple_music': {'artwork_url': 'https://is1-ssl.mzstatic.com/image/thumb/Music221/v4/c7/7e/c6/c77ec6cd-46ab-b621-aa9c-be98841eb701/198846190464.jpg/1000x1000bb.jpg', 'id': '1766053040', 'preview_url': 'https://audio-ssl.itunes.apple.com/itunes-assets/AudioPreview221/v4/3e/3f/4c/3e3f4c23-f701-6f71-36b9-01ebed9e1811/mzaf_13010628312286970068.plus.aac.p.m4a', 'url': 'https://music.apple.com/us/album/punish/1766052793?i=1766053040'}, 'image': 'https://www.billboard.com/wp-content/themes/vip/pmc-billboard-2021/assets/public/lazyload-fallback.gif', 'last_week_position': 0, 'name': 'Ethel Cain', ...}, {'apple_music': {'artwork_url': 'https://is1-ssl.mzstatic.com/image/thumb/Music122/v4/62/93/13/6293132e-20ff-67ab-3d1f-96bb6797a6ba/196589564955.jpg/1000x1000bb.jpg', 'id': '1658650488', 'preview_url': 'https://audio-ssl.itunes.apple.com/itunes-assets/AudioPreview126/v4/8f/38/16/8f38163f-a31a-a5a0-536f-6ac7a1ef0161/mzaf_288939289465559727.plus.aac.p.m4a', 'url': 'https://music.apple.com/us/album/kill-bill/1658650093?i=1658650488'}, 'image': 'https://charts-static.billboard.com/img/2017/07/sza-xyh-artistchart-ybr-180x180.jpg', 'last_week_position': 5, 'name': 'SZA', ...}, {'apple_music': {'artwork_url': 'https://is1-ssl.mzstatic.com/image/thumb/Music126/v4/fb/65/cb/fb65cb0f-4260-d740-d6f5-bb80c9c27c1b/23UMGIM84225.rgb.jpg/1000x1000bb.jpg', 'id': '1698723213', 'preview_url': 'https://audio-ssl.itunes.apple.com/itunes-assets/AudioPreview211/v4/b1/2d/85/b12d859d-280d-5d29-18d5-801c29c4ad91/mzaf_17329569521367990281.plus.aac.p.m4a', 'url': 'https://music.apple.com/us/album/coffee/1698723205?i=1698723213'}, 'image': 'https://charts-static.billboard.com/img/2023/10/chappellroan-bhw-artistchart-q4x-180x180.jpg', 'last_week_position': 6, 'name': 'Chappell Roan', ...}, ...], 'title': 'Billboard Artist 100', ...}

tests/test_billboard_api.py:43: AssertionError
_______________________ test_apple_music_parameter[true] _______________________

client = <FlaskClient <Flask 'app'>>, apple_music_param = 'true'

    @pytest.mark.parametrize("apple_music_param", ["true", "false"])
    def test_apple_music_parameter(client, apple_music_param):
        """Test apple_music parameter behavior"""
        # Act
        response = client.get(f'/billboard_api.php?apple_music={apple_music_param}')
    
        # Assert
        assert response.status_code == 200
        data = json.loads(response.data)
>       assert 'chart' in data
E       AssertionError: assert 'chart' in {'cached': False, 'info': 'THE WEEK’S MOST POPULAR CURRENT SONGS ACROSS ALL GENRES, RANKED BY STREAMING ACTIVITY FROM DIGITAL MUSIC SOURCES TRACKED BY LUMINATE, RADIO AIRPLAY AUDIENCE IMPRESSIONS AS MEASURED BY LUMINATE AND SALES DATA AS COMPILED BY LUMINATE.', 'songs': [{'apple_music': {'artwork_url': 'https://is1-ssl.mzstatic.com/image/thumb/Music211/v4/50/c2/cc/50c2cc95-3658-9417-0d4b-831abde44ba1/24UM1IM28978.rgb.jpg/1000x1000bb.jpg', 'id': '1781270323', 'preview_url': 'https://audio-ssl.itunes.apple.com/itunes-assets/AudioPreview221/v4/17/c5/2a/17c52a60-2867-4bc2-bbd3-5598f465ec15/mzaf_1780590825750947644.plus.aac.p.m4a', 'url': 'https://music.apple.com/us/album/luther/1781270319?i=1781270323'}, 'artist': 'Kendrick Lamar & SZA', 'image': 'https://charts-static.billboard.com/img/2010/10/kendrick-lamar-1hw-180x180.jpg', 'last_week_position': 1, ...}, {'apple_music': {'artwork_url': 'https://is1-ssl.mzstatic.com/image/thumb/Music211/v4/34/10/1e/34101e1f-f4b9-907a-ce47-3fba5b3ee5e8/50222.jpg/1000x1000bb.jpg', 'id': '1796127375', 'preview_url': 'https://audio-ssl.itunes.apple.com/itunes-assets/AudioPreview221/v4/a0/f9/8c/a0f98cba-a988-f47e-9f9e-491b4b44dd4e/mzaf_5519005314983652783.plus.aac.p.m4a', 'url': 'https://music.apple.com/us/album/nokia/1796127242?i=1796127375'}, 'artist': 'Drake', 'image': 'https://charts-static.billboard.com/img/2009/04/drake-8dm-180x180.jpg', 'last_week_position': 3, ...}, {'apple_music': {'artwork_url': 'https://is1-ssl.mzstatic.com/image/thumb/Music221/v4/11/ae/f2/11aef294-f57c-bab9-c9fc-529162984e62/24UMGIM85348.rgb.jpg/1000x1000bb.jpg', 'id': '1762656732', 'preview_url': 'https://audio-ssl.itunes.apple.com/itunes-assets/AudioPreview211/v4/e9/d1/46/e9d14699-9505-493e-cd27-a501095c81ff/mzaf_7283388936457278756.plus.aac.p.m4a', 'url': 'https://music.apple.com/us/album/die-with-a-smile/1762656724?i=1762656732'}, 'artist': 'Lady Gaga & Bruno Mars', 'image': 'https://charts-static.billboard.com/img/2024/08/lady-gaga-r3b-diewithasmile-6og-180x180.jpg', 'last_week_position': 2, ...}, {'apple_music': {'artwork_url': 'https://is1-ssl.mzstatic.com/image/thumb/Music221/v4/3e/53/0d/3e530db4-2838-53db-68a4-13b6d338d869/199231769579-copy-d6de5ccf.png/1000x1000bb.jpg', 'id': '1806169463', 'preview_url': 'https://audio-ssl.itunes.apple.com/itunes-assets/AudioPreview221/v4/45/4a/0f/454a0fc0-fd8a-c7a7-3efd-0c32799effb3/mzaf_5658331660598638284.plus.aac.p.m4a', 'url': 'https://music.apple.com/us/album/all-the-way/1806169462?i=1806169463'}, 'artist': 'BigXthaPlug Featuring Bailey Zimmerman', 'image': 'https://charts-static.billboard.com/img/2025/04/bigxthaplug-b0q-alltheway-z2y-180x180.jpg', 'last_week_position': 0, ...}, {'apple_music': {'artwork_url': 'https://is1-ssl.mzstatic.com/image/thumb/Music126/v4/41/bc/fb/41bcfb43-91d5-931d-5747-fb381803143f/23UMGIM21715.rgb.jpg/1000x1000bb.jpg', 'id': '1675173768', 'preview_url': 'https://audio-ssl.itunes.apple.com/itunes-assets/AudioPreview211/v4/b4/04/68/b4046869-8807-59be-e26f-5dba298d6c75/mzaf_4172540121850127763.plus.aac.p.m4a', 'url': 'https://music.apple.com/us/album/pink-pony-club/1675173434?i=1675173768'}, 'artist': 'Chappell Roan', 'image': 'https://charts-static.billboard.com/img/2024/06/chappellroan-bhw-pinkponyclub-14t-180x180.jpg', 'last_week_position': 5, ...}, {'apple_music': {'artwork_url': 'https://is1-ssl.mzstatic.com/image/thumb/Music211/v4/97/b5/bc/97b5bca2-6238-2421-4f0d-1f7a39d5d9d4/197342550925_cover.jpg/1000x1000bb.jpg', 'id': '1737085899', 'preview_url': 'https://audio-ssl.itunes.apple.com/itunes-assets/AudioPreview221/v4/2f/39/f0/2f39f017-bfcc-c6a0-9180-152915906a2f/mzaf_11282881139126018957.plus.aac.p.m4a', 'url': 'https://music.apple.com/us/album/a-bar-song-tipsy/1737085577?i=1737085899'}, 'artist': 'Shaboozey', 'image': 'https://charts-static.billboard.com/img/2024/04/shaboozey-2wm-abarsongtipsy-bat-180x180.jpg', 'last_week_position': 4, ...}, ...], 'title': 'Billboard Hot 100™', ...}

tests/test_billboard_api.py:116: AssertionError
______________________ test_apple_music_parameter[false] _______________________

client = <FlaskClient <Flask 'app'>>, apple_music_param = 'false'

    @pytest.mark.parametrize("apple_music_param", ["true", "false"])
    def test_apple_music_parameter(client, apple_music_param):
        """Test apple_music parameter behavior"""
        # Act
        response = client.get(f'/billboard_api.php?apple_music={apple_music_param}')
    
        # Assert
        assert response.status_code == 200
        data = json.loads(response.data)
>       assert 'chart' in data
E       AssertionError: assert 'chart' in {'cached': False, 'info': 'THE WEEK’S MOST POPULAR CURRENT SONGS ACROSS ALL GENRES, RANKED BY STREAMING ACTIVITY FROM DIGITAL MUSIC SOURCES TRACKED BY LUMINATE, RADIO AIRPLAY AUDIENCE IMPRESSIONS AS MEASURED BY LUMINATE AND SALES DATA AS COMPILED BY LUMINATE.', 'songs': [{'artist': 'Kendrick Lamar & SZA', 'image': 'https://charts-static.billboard.com/img/2010/10/kendrick-lamar-1hw-180x180.jpg', 'last_week_position': 1, 'name': 'Luther', ...}, {'artist': 'Drake', 'image': 'https://charts-static.billboard.com/img/2009/04/drake-8dm-180x180.jpg', 'last_week_position': 3, 'name': 'Nokia', ...}, {'artist': 'Lady Gaga & Bruno Mars', 'image': 'https://charts-static.billboard.com/img/2024/08/lady-gaga-r3b-diewithasmile-6og-180x180.jpg', 'last_week_position': 2, 'name': 'Die With A Smile', ...}, {'artist': 'BigXthaPlug Featuring Bailey Zimmerman', 'image': 'https://charts-static.billboard.com/img/2025/04/bigxthaplug-b0q-alltheway-z2y-180x180.jpg', 'last_week_position': 0, 'name': 'All The Way', ...}, {'artist': 'Chappell Roan', 'image': 'https://charts-static.billboard.com/img/2024/06/chappellroan-bhw-pinkponyclub-14t-180x180.jpg', 'last_week_position': 5, 'name': 'Pink Pony Club', ...}, {'artist': 'Shaboozey', 'image': 'https://charts-static.billboard.com/img/2024/04/shaboozey-2wm-abarsongtipsy-bat-180x180.jpg', 'last_week_position': 4, 'name': 'A Bar Song (Tipsy)', ...}, ...], 'title': 'Billboard Hot 100™', ...}

tests/test_billboard_api.py:116: AssertionError
_____________________ test_error_handling[rate_limit-429] ______________________

client = <FlaskClient <Flask 'app'>>
monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x104e708a0>
error_type = 'rate_limit', status_code = 429

    @pytest.mark.parametrize("error_type,status_code", [
        ("rate_limit", 429),
        ("server_error", 500)
    ])
    def test_error_handling(client, monkeypatch, error_type, status_code):
        """Test handling of API errors with fallback to cache"""
        # Arrange - First successful request to populate cache
        response = client.get('/billboard_api.php')
        assert response.status_code == 200
    
        # Mock error response
        class MockResponse:
            def __init__(self):
                self.status_code = status_code
                self._content = json.dumps({"error": f"{error_type} error"}).encode('utf-8')
    
            def json(self):
                return json.loads(self._content)
    
            def raise_for_status(self):
                raise requests.exceptions.HTTPError(f"{status_code} Error", response=self)
    
        # Arrange - Setup monkeypatch
        def mock_error_response(*args, **kwargs):
            raise requests.exceptions.HTTPError(f"{status_code} Error", response=MockResponse())
    
        monkeypatch.setattr(requests, 'get', mock_error_response)
    
        # Act - Make request that should trigger error
        response = client.get('/billboard_api.php')
        data = json.loads(response.data)
    
        # Assert - Should return cached data with note
        assert response.status_code == 200
        assert data['cached']
>       assert 'note' in data
E       AssertionError: assert 'note' in {'cached': True, 'info': 'THE WEEK’S MOST POPULAR CURRENT SONGS ACROSS ALL GENRES, RANKED BY STREAMING ACTIVITY FROM DIGITAL MUSIC SOURCES TRACKED BY LUMINATE, RADIO AIRPLAY AUDIENCE IMPRESSIONS AS MEASURED BY LUMINATE AND SALES DATA AS COMPILED BY LUMINATE.', 'songs': [{'artist': 'Kendrick Lamar & SZA', 'image': 'https://charts-static.billboard.com/img/2010/10/kendrick-lamar-1hw-180x180.jpg', 'last_week_position': 1, 'name': 'Luther', ...}, {'artist': 'Drake', 'image': 'https://charts-static.billboard.com/img/2009/04/drake-8dm-180x180.jpg', 'last_week_position': 3, 'name': 'Nokia', ...}, {'artist': 'Lady Gaga & Bruno Mars', 'image': 'https://charts-static.billboard.com/img/2024/08/lady-gaga-r3b-diewithasmile-6og-180x180.jpg', 'last_week_position': 2, 'name': 'Die With A Smile', ...}, {'artist': 'BigXthaPlug Featuring Bailey Zimmerman', 'image': 'https://charts-static.billboard.com/img/2025/04/bigxthaplug-b0q-alltheway-z2y-180x180.jpg', 'last_week_position': 0, 'name': 'All The Way', ...}, {'artist': 'Chappell Roan', 'image': 'https://charts-static.billboard.com/img/2024/06/chappellroan-bhw-pinkponyclub-14t-180x180.jpg', 'last_week_position': 5, 'name': 'Pink Pony Club', ...}, {'artist': 'Shaboozey', 'image': 'https://charts-static.billboard.com/img/2024/04/shaboozey-2wm-abarsongtipsy-bat-180x180.jpg', 'last_week_position': 4, 'name': 'A Bar Song (Tipsy)', ...}, ...], 'title': 'Billboard Hot 100™', ...}

tests/test_billboard_api.py:153: AssertionError
----------------------------- Captured stderr call -----------------------------
2025-04-16 14:15:14,979 - blueprints.billboard_api - ERROR - Error enriching chart data with Apple Music: max number of clients reached
2025-04-16 14:15:15,427 - blueprints.billboard_api - ERROR - Error searching Apple Music: 429 Error
2025-04-16 14:15:15,474 - blueprints.billboard_api - ERROR - Error searching Apple Music: 429 Error
2025-04-16 14:15:15,484 - blueprints.billboard_api - ERROR - Error searching Apple Music: 429 Error
2025-04-16 14:15:15,484 - blueprints.billboard_api - ERROR - Error searching Apple Music: 429 Error
2025-04-16 14:15:15,560 - blueprints.billboard_api - ERROR - Error enriching chart data with Apple Music: max number of clients reached
------------------------------ Captured log call -------------------------------
ERROR    blueprints.billboard_api:billboard_api.py:227 Error enriching chart data with Apple Music: max number of clients reached
ERROR    blueprints.billboard_api:billboard_api.py:168 Error searching Apple Music: 429 Error
ERROR    blueprints.billboard_api:billboard_api.py:168 Error searching Apple Music: 429 Error
ERROR    blueprints.billboard_api:billboard_api.py:168 Error searching Apple Music: 429 Error
ERROR    blueprints.billboard_api:billboard_api.py:168 Error searching Apple Music: 429 Error
ERROR    blueprints.billboard_api:billboard_api.py:227 Error enriching chart data with Apple Music: max number of clients reached
_______________________ test_exception_handling[timeout] _______________________

client = <FlaskClient <Flask 'app'>>
monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x103227650>
exception_type = 'timeout'

    @pytest.mark.parametrize("exception_type", ["timeout", "connection"])
    def test_exception_handling(client, monkeypatch, exception_type):
        """Test handling of request exceptions"""
        # Arrange - First successful request to populate cache
        client.get('/billboard_api.php')
    
        # Arrange - Setup exception
        if exception_type == "timeout":
            mock_exception = requests.exceptions.Timeout("Connection timed out")
        else:
            mock_exception = requests.exceptions.ConnectionError("Connection failed")
    
        # Arrange - Setup monkeypatch
        monkeypatch.setattr(requests, 'get', lambda *args, **kwargs: (_ for _ in ()).throw(mock_exception))
    
        # Act
        response = client.get('/billboard_api.php')
        data = json.loads(response.data)
    
        # Assert - Should use cached data
        assert response.status_code == 200
        assert data['cached']
>       assert 'note' in data
E       AssertionError: assert 'note' in {'cached': True, 'info': 'THE WEEK’S MOST POPULAR CURRENT SONGS ACROSS ALL GENRES, RANKED BY STREAMING ACTIVITY FROM DIGITAL MUSIC SOURCES TRACKED BY LUMINATE, RADIO AIRPLAY AUDIENCE IMPRESSIONS AS MEASURED BY LUMINATE AND SALES DATA AS COMPILED BY LUMINATE.', 'songs': [{'apple_music': {'artwork_url': 'https://is1-ssl.mzstatic.com/image/thumb/Music211/v4/50/c2/cc/50c2cc95-3658-9417-0d4b-831abde44ba1/24UM1IM28978.rgb.jpg/1000x1000bb.jpg', 'id': '1781270323', 'preview_url': 'https://audio-ssl.itunes.apple.com/itunes-assets/AudioPreview221/v4/17/c5/2a/17c52a60-2867-4bc2-bbd3-5598f465ec15/mzaf_1780590825750947644.plus.aac.p.m4a', 'url': 'https://music.apple.com/us/album/luther/1781270319?i=1781270323'}, 'artist': 'Kendrick Lamar & SZA', 'image': 'https://charts-static.billboard.com/img/2010/10/kendrick-lamar-1hw-180x180.jpg', 'last_week_position': 1, ...}, {'apple_music': {'artwork_url': 'https://is1-ssl.mzstatic.com/image/thumb/Music211/v4/34/10/1e/34101e1f-f4b9-907a-ce47-3fba5b3ee5e8/50222.jpg/1000x1000bb.jpg', 'id': '1796127375', 'preview_url': 'https://audio-ssl.itunes.apple.com/itunes-assets/AudioPreview221/v4/a0/f9/8c/a0f98cba-a988-f47e-9f9e-491b4b44dd4e/mzaf_5519005314983652783.plus.aac.p.m4a', 'url': 'https://music.apple.com/us/album/nokia/1796127242?i=1796127375'}, 'artist': 'Drake', 'image': 'https://charts-static.billboard.com/img/2009/04/drake-8dm-180x180.jpg', 'last_week_position': 3, ...}, {'apple_music': {'artwork_url': 'https://is1-ssl.mzstatic.com/image/thumb/Music221/v4/11/ae/f2/11aef294-f57c-bab9-c9fc-529162984e62/24UMGIM85348.rgb.jpg/1000x1000bb.jpg', 'id': '1762656732', 'preview_url': 'https://audio-ssl.itunes.apple.com/itunes-assets/AudioPreview211/v4/e9/d1/46/e9d14699-9505-493e-cd27-a501095c81ff/mzaf_7283388936457278756.plus.aac.p.m4a', 'url': 'https://music.apple.com/us/album/die-with-a-smile/1762656724?i=1762656732'}, 'artist': 'Lady Gaga & Bruno Mars', 'image': 'https://charts-static.billboard.com/img/2024/08/lady-gaga-r3b-diewithasmile-6og-180x180.jpg', 'last_week_position': 2, ...}, {'apple_music': {'artwork_url': 'https://is1-ssl.mzstatic.com/image/thumb/Music221/v4/3e/53/0d/3e530db4-2838-53db-68a4-13b6d338d869/199231769579-copy-d6de5ccf.png/1000x1000bb.jpg', 'id': '1806169463', 'preview_url': 'https://audio-ssl.itunes.apple.com/itunes-assets/AudioPreview221/v4/45/4a/0f/454a0fc0-fd8a-c7a7-3efd-0c32799effb3/mzaf_5658331660598638284.plus.aac.p.m4a', 'url': 'https://music.apple.com/us/album/all-the-way/1806169462?i=1806169463'}, 'artist': 'BigXthaPlug Featuring Bailey Zimmerman', 'image': 'https://charts-static.billboard.com/img/2025/04/bigxthaplug-b0q-alltheway-z2y-180x180.jpg', 'last_week_position': 0, ...}, {'apple_music': {'artwork_url': 'https://is1-ssl.mzstatic.com/image/thumb/Music126/v4/41/bc/fb/41bcfb43-91d5-931d-5747-fb381803143f/23UMGIM21715.rgb.jpg/1000x1000bb.jpg', 'id': '1675173768', 'preview_url': 'https://audio-ssl.itunes.apple.com/itunes-assets/AudioPreview211/v4/b4/04/68/b4046869-8807-59be-e26f-5dba298d6c75/mzaf_4172540121850127763.plus.aac.p.m4a', 'url': 'https://music.apple.com/us/album/pink-pony-club/1675173434?i=1675173768'}, 'artist': 'Chappell Roan', 'image': 'https://charts-static.billboard.com/img/2024/06/chappellroan-bhw-pinkponyclub-14t-180x180.jpg', 'last_week_position': 5, ...}, {'apple_music': {'artwork_url': 'https://is1-ssl.mzstatic.com/image/thumb/Music211/v4/97/b5/bc/97b5bca2-6238-2421-4f0d-1f7a39d5d9d4/197342550925_cover.jpg/1000x1000bb.jpg', 'id': '1737085899', 'preview_url': 'https://audio-ssl.itunes.apple.com/itunes-assets/AudioPreview221/v4/2f/39/f0/2f39f017-bfcc-c6a0-9180-152915906a2f/mzaf_11282881139126018957.plus.aac.p.m4a', 'url': 'https://music.apple.com/us/album/a-bar-song-tipsy/1737085577?i=1737085899'}, 'artist': 'Shaboozey', 'image': 'https://charts-static.billboard.com/img/2024/04/shaboozey-2wm-abarsongtipsy-bat-180x180.jpg', 'last_week_position': 4, ...}, ...], 'title': 'Billboard Hot 100™', ...}

tests/test_billboard_api.py:182: AssertionError
_____________________ test_exception_handling[connection] ______________________

client = <FlaskClient <Flask 'app'>>
monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x1037f4c00>
exception_type = 'connection'

    @pytest.mark.parametrize("exception_type", ["timeout", "connection"])
    def test_exception_handling(client, monkeypatch, exception_type):
        """Test handling of request exceptions"""
        # Arrange - First successful request to populate cache
        client.get('/billboard_api.php')
    
        # Arrange - Setup exception
        if exception_type == "timeout":
            mock_exception = requests.exceptions.Timeout("Connection timed out")
        else:
            mock_exception = requests.exceptions.ConnectionError("Connection failed")
    
        # Arrange - Setup monkeypatch
        monkeypatch.setattr(requests, 'get', lambda *args, **kwargs: (_ for _ in ()).throw(mock_exception))
    
        # Act
        response = client.get('/billboard_api.php')
        data = json.loads(response.data)
    
        # Assert - Should use cached data
        assert response.status_code == 200
        assert data['cached']
>       assert 'note' in data
E       AssertionError: assert 'note' in {'cached': True, 'info': 'THE WEEK’S MOST POPULAR CURRENT SONGS ACROSS ALL GENRES, RANKED BY STREAMING ACTIVITY FROM DIGITAL MUSIC SOURCES TRACKED BY LUMINATE, RADIO AIRPLAY AUDIENCE IMPRESSIONS AS MEASURED BY LUMINATE AND SALES DATA AS COMPILED BY LUMINATE.', 'songs': [{'apple_music': {'artwork_url': 'https://is1-ssl.mzstatic.com/image/thumb/Music211/v4/50/c2/cc/50c2cc95-3658-9417-0d4b-831abde44ba1/24UM1IM28978.rgb.jpg/1000x1000bb.jpg', 'id': '1781270323', 'preview_url': 'https://audio-ssl.itunes.apple.com/itunes-assets/AudioPreview221/v4/17/c5/2a/17c52a60-2867-4bc2-bbd3-5598f465ec15/mzaf_1780590825750947644.plus.aac.p.m4a', 'url': 'https://music.apple.com/us/album/luther/1781270319?i=1781270323'}, 'artist': 'Kendrick Lamar & SZA', 'image': 'https://charts-static.billboard.com/img/2010/10/kendrick-lamar-1hw-180x180.jpg', 'last_week_position': 1, ...}, {'apple_music': {'artwork_url': 'https://is1-ssl.mzstatic.com/image/thumb/Music211/v4/34/10/1e/34101e1f-f4b9-907a-ce47-3fba5b3ee5e8/50222.jpg/1000x1000bb.jpg', 'id': '1796127375', 'preview_url': 'https://audio-ssl.itunes.apple.com/itunes-assets/AudioPreview221/v4/a0/f9/8c/a0f98cba-a988-f47e-9f9e-491b4b44dd4e/mzaf_5519005314983652783.plus.aac.p.m4a', 'url': 'https://music.apple.com/us/album/nokia/1796127242?i=1796127375'}, 'artist': 'Drake', 'image': 'https://charts-static.billboard.com/img/2009/04/drake-8dm-180x180.jpg', 'last_week_position': 3, ...}, {'apple_music': {'artwork_url': 'https://is1-ssl.mzstatic.com/image/thumb/Music221/v4/11/ae/f2/11aef294-f57c-bab9-c9fc-529162984e62/24UMGIM85348.rgb.jpg/1000x1000bb.jpg', 'id': '1762656732', 'preview_url': 'https://audio-ssl.itunes.apple.com/itunes-assets/AudioPreview211/v4/e9/d1/46/e9d14699-9505-493e-cd27-a501095c81ff/mzaf_7283388936457278756.plus.aac.p.m4a', 'url': 'https://music.apple.com/us/album/die-with-a-smile/1762656724?i=1762656732'}, 'artist': 'Lady Gaga & Bruno Mars', 'image': 'https://charts-static.billboard.com/img/2024/08/lady-gaga-r3b-diewithasmile-6og-180x180.jpg', 'last_week_position': 2, ...}, {'apple_music': {'artwork_url': 'https://is1-ssl.mzstatic.com/image/thumb/Music221/v4/3e/53/0d/3e530db4-2838-53db-68a4-13b6d338d869/199231769579-copy-d6de5ccf.png/1000x1000bb.jpg', 'id': '1806169463', 'preview_url': 'https://audio-ssl.itunes.apple.com/itunes-assets/AudioPreview221/v4/45/4a/0f/454a0fc0-fd8a-c7a7-3efd-0c32799effb3/mzaf_5658331660598638284.plus.aac.p.m4a', 'url': 'https://music.apple.com/us/album/all-the-way/1806169462?i=1806169463'}, 'artist': 'BigXthaPlug Featuring Bailey Zimmerman', 'image': 'https://charts-static.billboard.com/img/2025/04/bigxthaplug-b0q-alltheway-z2y-180x180.jpg', 'last_week_position': 0, ...}, {'apple_music': {'artwork_url': 'https://is1-ssl.mzstatic.com/image/thumb/Music126/v4/41/bc/fb/41bcfb43-91d5-931d-5747-fb381803143f/23UMGIM21715.rgb.jpg/1000x1000bb.jpg', 'id': '1675173768', 'preview_url': 'https://audio-ssl.itunes.apple.com/itunes-assets/AudioPreview211/v4/b4/04/68/b4046869-8807-59be-e26f-5dba298d6c75/mzaf_4172540121850127763.plus.aac.p.m4a', 'url': 'https://music.apple.com/us/album/pink-pony-club/1675173434?i=1675173768'}, 'artist': 'Chappell Roan', 'image': 'https://charts-static.billboard.com/img/2024/06/chappellroan-bhw-pinkponyclub-14t-180x180.jpg', 'last_week_position': 5, ...}, {'apple_music': {'artwork_url': 'https://is1-ssl.mzstatic.com/image/thumb/Music211/v4/97/b5/bc/97b5bca2-6238-2421-4f0d-1f7a39d5d9d4/197342550925_cover.jpg/1000x1000bb.jpg', 'id': '1737085899', 'preview_url': 'https://audio-ssl.itunes.apple.com/itunes-assets/AudioPreview221/v4/2f/39/f0/2f39f017-bfcc-c6a0-9180-152915906a2f/mzaf_11282881139126018957.plus.aac.p.m4a', 'url': 'https://music.apple.com/us/album/a-bar-song-tipsy/1737085577?i=1737085899'}, 'artist': 'Shaboozey', 'image': 'https://charts-static.billboard.com/img/2024/04/shaboozey-2wm-abarsongtipsy-bat-180x180.jpg', 'last_week_position': 4, ...}, ...], 'title': 'Billboard Hot 100™', ...}

tests/test_billboard_api.py:182: AssertionError
_______________________________ test_null_values _______________________________

app_context = None

    def test_null_values(app_context):
        """Test caching and retrieving null/None values"""
        # Arrange
        null_key = "null_test"
        missing_key = "missing_key"
        cache.delete(missing_key)  # Ensure key doesn't exist
    
        # Act - Cache a None value
        cache.set(null_key, None)
    
        # Assert - Both keys return None, but for different reasons
        assert cache.get(null_key) is None  # Explicitly stored None
        assert cache.get(missing_key) is None  # Key doesn't exist
    
        # Differentiate using get_many
>       many_result = cache.get_many([null_key, missing_key])

tests/test_caching.py:135: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
venv/lib/python3.13/site-packages/flask_caching/__init__.py:218: in get_many
    return self.cache.get_many(*args, **kwargs)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <flask_caching.backends.rediscache.RedisCache object at 0x104eee040>
keys = (['null_test', 'missing_key'],)

    def get_many(self, *keys: str) -> _t.List[_t.Any]:
        if self.key_prefix:
>           prefixed_keys = [self.key_prefix + key for key in keys]
E           TypeError: can only concatenate str (not "list") to str

venv/lib/python3.13/site-packages/cachelib/redis.py:76: TypeError
______________________ test_chart_retrieval_with_caching _______________________

client = <FlaskClient <Flask 'app'>>, requires_api_key = None

    def test_chart_retrieval_with_caching(client, requires_api_key):
        """Test the complete chart retrieval pipeline with caching"""
        # Act - First request (cold cache)
        start_time = time.time()
        response1 = client.get('/billboard_api.php')
        first_request_time = time.time() - start_time
    
        # Assert - First request
        assert response1.status_code == 200
        data1 = json.loads(response1.data)
        assert not data1['cached']
>       assert 'chart' in data1
E       AssertionError: assert 'chart' in {'cached': False, 'info': 'THE WEEK’S MOST POPULAR CURRENT SONGS ACROSS ALL GENRES, RANKED BY STREAMING ACTIVITY FROM DIGITAL MUSIC SOURCES TRACKED BY LUMINATE, RADIO AIRPLAY AUDIENCE IMPRESSIONS AS MEASURED BY LUMINATE AND SALES DATA AS COMPILED BY LUMINATE.', 'songs': [{'apple_music': {'artwork_url': 'https://is1-ssl.mzstatic.com/image/thumb/Music211/v4/50/c2/cc/50c2cc95-3658-9417-0d4b-831abde44ba1/24UM1IM28978.rgb.jpg/1000x1000bb.jpg', 'id': '1781270323', 'preview_url': 'https://audio-ssl.itunes.apple.com/itunes-assets/AudioPreview221/v4/17/c5/2a/17c52a60-2867-4bc2-bbd3-5598f465ec15/mzaf_1780590825750947644.plus.aac.p.m4a', 'url': 'https://music.apple.com/us/album/luther/1781270319?i=1781270323'}, 'artist': 'Kendrick Lamar & SZA', 'image': 'https://charts-static.billboard.com/img/2010/10/kendrick-lamar-1hw-180x180.jpg', 'last_week_position': 1, ...}, {'apple_music': {'artwork_url': 'https://is1-ssl.mzstatic.com/image/thumb/Music211/v4/34/10/1e/34101e1f-f4b9-907a-ce47-3fba5b3ee5e8/50222.jpg/1000x1000bb.jpg', 'id': '1796127375', 'preview_url': 'https://audio-ssl.itunes.apple.com/itunes-assets/AudioPreview221/v4/a0/f9/8c/a0f98cba-a988-f47e-9f9e-491b4b44dd4e/mzaf_5519005314983652783.plus.aac.p.m4a', 'url': 'https://music.apple.com/us/album/nokia/1796127242?i=1796127375'}, 'artist': 'Drake', 'image': 'https://charts-static.billboard.com/img/2009/04/drake-8dm-180x180.jpg', 'last_week_position': 3, ...}, {'apple_music': {'artwork_url': 'https://is1-ssl.mzstatic.com/image/thumb/Music221/v4/11/ae/f2/11aef294-f57c-bab9-c9fc-529162984e62/24UMGIM85348.rgb.jpg/1000x1000bb.jpg', 'id': '1762656732', 'preview_url': 'https://audio-ssl.itunes.apple.com/itunes-assets/AudioPreview211/v4/e9/d1/46/e9d14699-9505-493e-cd27-a501095c81ff/mzaf_7283388936457278756.plus.aac.p.m4a', 'url': 'https://music.apple.com/us/album/die-with-a-smile/1762656724?i=1762656732'}, 'artist': 'Lady Gaga & Bruno Mars', 'image': 'https://charts-static.billboard.com/img/2024/08/lady-gaga-r3b-diewithasmile-6og-180x180.jpg', 'last_week_position': 2, ...}, {'apple_music': {'artwork_url': 'https://is1-ssl.mzstatic.com/image/thumb/Music221/v4/3e/53/0d/3e530db4-2838-53db-68a4-13b6d338d869/199231769579-copy-d6de5ccf.png/1000x1000bb.jpg', 'id': '1806169463', 'preview_url': 'https://audio-ssl.itunes.apple.com/itunes-assets/AudioPreview221/v4/45/4a/0f/454a0fc0-fd8a-c7a7-3efd-0c32799effb3/mzaf_5658331660598638284.plus.aac.p.m4a', 'url': 'https://music.apple.com/us/album/all-the-way/1806169462?i=1806169463'}, 'artist': 'BigXthaPlug Featuring Bailey Zimmerman', 'image': 'https://charts-static.billboard.com/img/2025/04/bigxthaplug-b0q-alltheway-z2y-180x180.jpg', 'last_week_position': 0, ...}, {'apple_music': {'artwork_url': 'https://is1-ssl.mzstatic.com/image/thumb/Music126/v4/41/bc/fb/41bcfb43-91d5-931d-5747-fb381803143f/23UMGIM21715.rgb.jpg/1000x1000bb.jpg', 'id': '1675173768', 'preview_url': 'https://audio-ssl.itunes.apple.com/itunes-assets/AudioPreview211/v4/b4/04/68/b4046869-8807-59be-e26f-5dba298d6c75/mzaf_4172540121850127763.plus.aac.p.m4a', 'url': 'https://music.apple.com/us/album/pink-pony-club/1675173434?i=1675173768'}, 'artist': 'Chappell Roan', 'image': 'https://charts-static.billboard.com/img/2024/06/chappellroan-bhw-pinkponyclub-14t-180x180.jpg', 'last_week_position': 5, ...}, {'apple_music': {'artwork_url': 'https://is1-ssl.mzstatic.com/image/thumb/Music211/v4/97/b5/bc/97b5bca2-6238-2421-4f0d-1f7a39d5d9d4/197342550925_cover.jpg/1000x1000bb.jpg', 'id': '1737085899', 'preview_url': 'https://audio-ssl.itunes.apple.com/itunes-assets/AudioPreview221/v4/2f/39/f0/2f39f017-bfcc-c6a0-9180-152915906a2f/mzaf_11282881139126018957.plus.aac.p.m4a', 'url': 'https://music.apple.com/us/album/a-bar-song-tipsy/1737085577?i=1737085899'}, 'artist': 'Shaboozey', 'image': 'https://charts-static.billboard.com/img/2024/04/shaboozey-2wm-abarsongtipsy-bat-180x180.jpg', 'last_week_position': 4, ...}, ...], 'title': 'Billboard Hot 100™', ...}

tests/test_integration.py:38: AssertionError
______________________ test_historical_chart[2000-01-01] _______________________

client = <FlaskClient <Flask 'app'>>, requires_api_key = None
date = '2000-01-01'

    @pytest.mark.parametrize("date", HISTORICAL_TEST_DATES[:1])  # Use just one date for efficiency
    def test_historical_chart(client, requires_api_key, date):
        """Test retrieving historical chart data"""
        # Act - Request historical chart
        response = client.get(f'/billboard_api.php?week={date}')
    
        # Assert
        assert response.status_code == 200
        data = json.loads(response.data)
>       assert 'chart' in data
E       AssertionError: assert 'chart' in {'cached': False, 'info': 'THE WEEK’S MOST POPULAR CURRENT SONGS ACROSS ALL GENRES, RANKED BY STREAMING ACTIVITY FROM DIGITAL MUSIC SOURCES TRACKED BY LUMINATE, RADIO AIRPLAY AUDIENCE IMPRESSIONS AS MEASURED BY LUMINATE AND SALES DATA AS COMPILED BY LUMINATE.', 'songs': [{'apple_music': {'artwork_url': 'https://is1-ssl.mzstatic.com/image/thumb/Music124/v4/f5/97/4c/f5974c1e-06cb-f84c-1da9-5f7505a20a0c/mzi.etsqfvqq.jpg/1000x1000bb.jpg', 'id': '354579303', 'preview_url': 'https://audio-ssl.itunes.apple.com/itunes-assets/AudioPreview125/v4/ad/80/8a/ad808ad8-500e-106d-c469-b442734e7de2/mzaf_14968327396834426036.plus.aac.p.m4a', 'url': 'https://music.apple.com/us/album/smooth-feat-rob-thomas/354579273?i=354579303'}, 'artist': 'Santana Featuring Rob Thomas', 'image': 'https://charts-static.billboard.com/img/1969/09/santana-84r-180x180.jpg', 'last_week_position': 1, ...}, {'apple_music': {'artwork_url': 'https://is1-ssl.mzstatic.com/image/thumb/Music116/v4/da/d3/e5/dad3e5f1-91ec-13bd-c905-e0862880aaee/06UMGIM32674.rgb.jpg/1000x1000bb.jpg', 'id': '1440635963', 'preview_url': 'https://audio-ssl.itunes.apple.com/itunes-assets/AudioPreview126/v4/85/73/3b/85733bf3-1ac9-39b8-1078-039605e34bfa/mzaf_6018408956258909209.plus.aac.p.m4a', 'url': 'https://music.apple.com/us/album/back-at-one/1440635644?i=1440635963'}, 'artist': 'Brian McKnight', 'image': 'https://charts-static.billboard.com/img/1999/08/brian-mcknight-uld-backatone-nl9-180x180.jpg', 'last_week_position': 2, ...}, {'apple_music': {'artwork_url': 'https://is1-ssl.mzstatic.com/image/thumb/Music/a9/46/58/mzi.pnvhwzas.jpg/1000x1000bb.jpg', 'id': '158614528', 'preview_url': 'https://audio-ssl.itunes.apple.com/itunes-assets/AudioPreview115/v4/2e/6a/aa/2e6aaa27-9d1c-6f8e-d375-9801e45735e6/mzaf_3182745094746791027.plus.aac.p.m4a', 'url': 'https://music.apple.com/us/album/i-wanna-love-you-forever/158614417?i=158614528'}, 'artist': 'Jessica Simpson', 'image': 'https://charts-static.billboard.com/img/1999/10/jessica-simpson-sz9-180x180.jpg', 'last_week_position': 3, ...}, {'apple_music': {'artwork_url': 'https://is1-ssl.mzstatic.com/image/thumb/Music221/v4/4b/fb/0c/4bfb0cca-77b7-380c-a8aa-f59de0560b6b/078221903721.jpg/1000x1000bb.jpg', 'id': '251090745', 'preview_url': 'https://audio-ssl.itunes.apple.com/itunes-assets/AudioPreview221/v4/af/26/3c/af263c34-de1c-9716-50df-c5b4e2ad92cd/mzaf_4171327403653857969.plus.aac.p.m4a', 'url': 'https://music.apple.com/us/album/my-love-is-your-love/251090652?i=251090745'}, 'artist': 'Whitney Houston', 'image': 'https://charts-static.billboard.com/img/1984/06/whitney-houston-u3i-180x180.jpg', 'last_week_position': 5, ...}, {'apple_music': {'artwork_url': 'https://is1-ssl.mzstatic.com/image/thumb/Music/d7/21/7f/mzi.bcoqqnsb.jpg/1000x1000bb.jpg', 'id': '157390097', 'preview_url': 'https://audio-ssl.itunes.apple.com/itunes-assets/AudioPreview115/v4/55/65/46/5565466a-6dee-7c6a-9499-aadce23143cd/mzaf_2809983600078813883.plus.aac.p.m4a', 'url': 'https://music.apple.com/us/album/i-knew-i-loved-you/157389797?i=157390097'}, 'artist': 'Savage Garden', 'image': 'https://charts-static.billboard.com/img/1999/10/savage-garden-l4s-180x180.jpg', 'last_week_position': 4, ...}, {'apple_music': {'artwork_url': 'https://is1-ssl.mzstatic.com/image/thumb/Music124/v4/aa/a6/a4/aaa6a483-7a2a-f226-9cb4-67f79c695380/mzi.hgovnkjb.jpg/1000x1000bb.jpg', 'id': '191009391', 'preview_url': 'https://audio-ssl.itunes.apple.com/itunes-assets/AudioPreview125/v4/dd/41/af/dd41af4d-cd0c-50fd-af46-0010845eb2b9/mzaf_5792806308998111219.plus.aac.p.m4a', 'url': 'https://music.apple.com/us/album/i-need-to-know/191009179?i=191009391'}, 'artist': 'Marc Anthony', 'image': 'https://charts-static.billboard.com/img/1991/08/marc-anthony-iab-180x180.jpg', 'last_week_position': 6, ...}, ...], 'title': 'Billboard Hot 100™', ...}

tests/test_integration.py:61: AssertionError
_____________________ test_performance_of_cached_responses _____________________

client = <FlaskClient <Flask 'app'>>, requires_api_key = None

    def test_performance_of_cached_responses(client, requires_api_key):
        """Test performance of cached responses"""
        # Arrange - Populate cache
        client.get('/billboard_api.php')
    
        # Act - Make multiple cached requests
        response_times = []
        for _ in range(5):  # 5 requests is sufficient for timing test
            start = time.time()
            response = client.get('/billboard_api.php')
            end = time.time()
            response_times.append(end - start)
            data = json.loads(response.data)
            assert data['cached']  # Verify we're testing cached responses
    
        # Assert - All cached responses should be fast (under 100ms is reasonable)
        # This threshold might need adjustment based on the testing environment
>       assert all(t < 0.1 for t in response_times), "Cached responses too slow"
E       AssertionError: Cached responses too slow
E       assert False
E        +  where False = all(<generator object test_performance_of_cached_responses.<locals>.<genexpr> at 0x103785490>)

tests/test_integration.py:135: AssertionError
=========================== short test summary info ============================
FAILED tests/test_apple_music.py::test_missing_credentials - AssertionError: ...
FAILED tests/test_billboard_api.py::test_get_default_chart - KeyError: 'chart'
FAILED tests/test_billboard_api.py::test_get_chart_by_id[billboard-200] - Ass...
FAILED tests/test_billboard_api.py::test_get_chart_by_id[artist-100] - Assert...
FAILED tests/test_billboard_api.py::test_apple_music_parameter[true] - Assert...
FAILED tests/test_billboard_api.py::test_apple_music_parameter[false] - Asser...
FAILED tests/test_billboard_api.py::test_error_handling[rate_limit-429] - Ass...
FAILED tests/test_billboard_api.py::test_exception_handling[timeout] - Assert...
FAILED tests/test_billboard_api.py::test_exception_handling[connection] - Ass...
FAILED tests/test_caching.py::test_null_values - TypeError: can only concaten...
FAILED tests/test_integration.py::test_chart_retrieval_with_caching - Asserti...
FAILED tests/test_integration.py::test_historical_chart[2000-01-01] - Asserti...
FAILED tests/test_integration.py::test_performance_of_cached_responses - Asse...
ERROR tests/test_billboard_api.py::test_error_handling[server_error-500] - re...
ERROR tests/test_caching.py::test_cache_timeout[None-False] - redis.exception...
ERROR tests/test_caching.py::test_application_cache_patterns[billboard:rate_limited-True]
ERROR tests/test_integration.py::test_apple_music_integration[true] - redis.e...
ERROR tests/test_integration.py::test_apple_music_integration[false] - redis....
ERROR tests/test_integration.py::test_concurrent_chart_requests - LookupError...
======= 13 failed, 23 passed, 10 skipped, 6 errors in 295.99s (0:04:55) ========
